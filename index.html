<html>
<head>
    <meta charset="utf-8">
    <title>goofy gophers</title>
    <style>

    </style>
    <script>
        var url = "ws://" + window.location.host + "/ws";
        var ws = new WebSocket(url);
        var myid = -1;
/* -------------------- */
        var can;
        var ct;
        //var ox=0,oy=0,x=0,y=0;
        var mf=false;
          function mam_draw_init(){
            //初期設定
            can=document.getElementById("can");
            can.addEventListener("touchstart",onDown,false);
            can.addEventListener("touchmove",onMove,false);
            can.addEventListener("touchend",onUp,false);
            can.addEventListener("mousedown",onMouseDown,false);
            can.addEventListener("mousemove",onMouseMove,false);
            can.addEventListener("mouseup",onMouseUp,false);
            ct=can.getContext("2d");
            ct.strokeStyle="#000000";
            ct.lineWidth=5;
            ct.lineJoin="round";
            ct.lineCap="round";
            clearCan();
          }
/* -------------------- */

        ws.onmessage = function (msg) {
          var cmds = {"iam": iam, "set": set, "dis": dis};
          if (msg.data) {
            var parts = msg.data.split(" ")
            var cmd = cmds[parts[0]];
            if (cmd) {
              cmd.apply(null, parts.slice(1));
            }
          }
        };

        function iam(id) {
          myid = id;
        }

        //drawLineが(id x y ox oy)5変数でここに来ると思う
        function set(id, x, y) {
            //ウェブソケのidを元に動かすgopherを指定　なければ追加
          var node = document.getElementById("gopher-" + id);
          if (!node) {
            node = document.createElement("div");
            document.body.appendChild(node);
            node.className = "gopher";
            node.style.zIndex = id + 1;
            node.id = "gopher-" + id;
          }
        //gopherを動かしているところ
          node.style.left = x + "px";
          node.style.top = y + "px";
        }

        function dis(id) {
          var node = document.getElementById("gopher-" + id);
          if (node) {
            document.body.removeChild(node);
          }
        }

        /*
          onMouseDown
          onMouseMove
          onMouseUp

          set(myid, x, y, ox, oy)
          ws.send(x, y, ox, oy).join(" "));
        */

        window.onmousemove = function (e) {
          if (myid > -1) {
            //手元の関数呼びつつウェブソケで送信&Goでブロキャス
            //joinはたぶん配列の間に勝手にスペース入れてくれるメソッド
            set(myid, e.pageX, e.pageY);
            ws.send([e.pageX, e.pageY].join(" "));
          }
        }
    </script>
</head>
<body>
    <h3>手書きお絵かきJavascriptサンプル</h3>
    <div style="border:solid 1px #000000;width:400px;" id="candiv">
      <canvas id="can" width="400px" height="300px"></canvas>
    </div>
    <input type="button" onClick="clearCan();" value="クリア" style="width:100;height:30;" data-inline="true" />
</body>
</html>
